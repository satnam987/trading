<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Trading Journal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 16px; box-shadow: 0 6px 16px rgba(10, 22, 50, .06); }
    .stat-card { border: none; }
    .stat-value { font-size: 1.6rem; font-weight: 700; }
    .positive { color: #16a34a; }
    .negative { color: #dc2626; }
    .chart-container { height: 380px; }
    .table { border-radius: 12px; overflow: hidden; }
  </style>
</head>
<body>
  <div class="container my-5">
    <header class="text-center mb-4">
      <h1 class="display-5 fw-bold">Trading Journal</h1>
      <p class="text-muted mb-0">Log trades, track performance, and view your P&L trend</p>
    </header>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card stat-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted">Total Trades</div>
              <div id="statTrades" class="stat-value">0</div>
            </div>
            <span class="badge text-bg-primary">All time</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card stat-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted">Winrate</div>
              <div id="statWinrate" class="stat-value">-</div>
            </div>
            <span class="badge text-bg-success">% wins</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card stat-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted">Total P&L</div>
              <div id="statTotalPnL" class="stat-value">0.00</div>
            </div>
            <span class="badge text-bg-secondary">Sum</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Add New Trade</h5>
        <form id="addTradeForm">
          <div class="row g-3">
            <div class="col-md-3">
              <input type="date" class="form-control" id="tradeDate" required>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="tradePair" required>
                <option value="">Select Pair</option>
                <option value="EURUSD">EURUSD</option>
                <option value="TECH100">TECH100</option>
                <option value="BTCUSD">BTCUSD</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="tradeDirection" required>
                <option value="">Direction</option>
                <option value="buy">Buy</option>
                <option value="sell">Sell</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="number" class="form-control" id="tradeSize" placeholder="Size" step="0.01">
            </div>
            <div class="col-md-3">
              <input type="number" class="form-control" id="tradePnL" placeholder="P&L" step="0.01" required>
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control" id="tradeStrategy" placeholder="Strategy (optional)">
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">Add Trade</button>
            </div>
            <div class="col-12">
              <textarea class="form-control" id="tradeNotes" rows="2" placeholder="Notes"></textarea>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Trade Journal</h5>
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Pair</th>
              <th>Direction</th>
              <th>Size</th>
              <th>P&L</th>
              <th>Strategy</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tradesTbody"></tbody>
          <tfoot>
            <tr class="fw-bold">
              <td colspan="3">Totals</td>
              <td id="totalSize">0.00</td>
              <td id="totalPnL">0.00</td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Cumulative P&L Trend</h5>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <div class="text-center">
      <button id="btnExportJson" class="btn btn-secondary me-2">Export JSON</button>
      <button id="btnExportCsv" class="btn btn-secondary me-2">Export CSV</button>
      
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script>
    const trades = [];
    const STORAGE_KEY = 'trading:journal.v1';
    const AVAILABLE_PAIRS = ['EURUSD', 'TECH100', 'BTCUSD'];

    let chartRef = null;

    function createId() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODateOnly(d = new Date()) { return d.toISOString().split('T')[0]; }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.trades)) trades.push(...parsed.trades);
        }
      } catch (_) {}
      // default date
      const dateEl = document.getElementById('tradeDate');
      if (dateEl && !dateEl.value) dateEl.value = toISODateOnly();
      render();
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ trades })); }

    // Send event to serverless function to append into monthly txt on GitHub
    async function sendEvent(eventName, payload) {
      try {
        await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ event: eventName, payload })
        });
      } catch (_) { /* ignore network errors */ }
    }

    function calculatePnL(trade) { return Number(trade.pnl) || 0; }

    function addTrade(tradeData) {
      const trade = { id: createId(), ...tradeData };
      trades.push(trade);
      saveState();
      render();
      // Persist externally per new trade
      // Choose storage format if needed: 'json' (default) or 'txt'
      // Best effort; ignore errors in UI
      sendEvent('trade:add', { trade });
    }

    function removeTrade(id) {
      const idx = trades.findIndex(t => t.id === id);
      if (idx !== -1) trades.splice(idx, 1);
      saveState();
      render();
    }

    function render() {
      const tbody = document.getElementById('tradesTbody');
      tbody.innerHTML = '';

      let totalPnL = 0;
      let totalSize = 0;
      let wins = 0;

      trades
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .forEach(t => {
          const pnl = calculatePnL(t);
          totalPnL += pnl;
          totalSize += Number(t.size) || 0;
          if (pnl > 0) wins += 1;

          const tr = document.createElement('tr');
          tr.dataset.id = t.id;
          tr.innerHTML = `
            <td>${t.date}</td>
            <td>${t.pair}</td>
            <td>${t.direction}</td>
            <td>${(Number(t.size) || 0).toFixed(2)}</td>
            <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl.toFixed(2)}</td>
            <td>${t.strategy || ''}</td>
            <td>${t.notes || ''}</td>
            <td><button class="btn btn-sm btn-outline-danger remove-btn">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });

      const total = trades.length;
      const winrate = total ? ((wins / total) * 100).toFixed(1) + '%' : '-';

      document.getElementById('totalPnL').textContent = totalPnL.toFixed(2);
      document.getElementById('totalPnL').className = totalPnL >= 0 ? 'positive' : 'negative';
      document.getElementById('totalSize').textContent = totalSize.toFixed(2);

      document.getElementById('statTrades').textContent = String(total);
      document.getElementById('statWinrate').textContent = winrate;
      document.getElementById('statTotalPnL').textContent = totalPnL.toFixed(2);
      document.getElementById('statTotalPnL').className = 'stat-value ' + (totalPnL >= 0 ? 'positive' : 'negative');

      renderChart();
    }

    function renderChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      const sorted = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
      let cumulative = 0;
      const labels = sorted.map(t => t.date);
      const data = sorted.map(t => { cumulative += calculatePnL(t); return cumulative; });

      if (chartRef) chartRef.destroy();
      chartRef = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Cumulative P&L', data, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,.08)', fill: true, tension: .25 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    document.getElementById('addTradeForm').addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('tradeDate').value;
      const pair = document.getElementById('tradePair').value;
      const direction = document.getElementById('tradeDirection').value;
      const size = parseFloat(document.getElementById('tradeSize').value) || 0;
      const pnl = parseFloat(document.getElementById('tradePnL').value) || 0;
      const strategy = document.getElementById('tradeStrategy').value;
      const notes = document.getElementById('tradeNotes').value;
      addTrade({ date, pair, direction, size, pnl, strategy, notes });
      e.target.reset();
      document.getElementById('tradeDate').value = toISODateOnly();
    });

    document.getElementById('tradesTbody').addEventListener('click', e => {
      if (e.target.classList.contains('remove-btn')) {
        const id = e.target.closest('tr').dataset.id;
        removeTrade(id);
      }
    });

    document.getElementById('btnExportJson').addEventListener('click', () => {
      const data = JSON.stringify({ trades }, null, 2);
      downloadBlob(data, 'trading-journal.json', 'application/json');
    });

    document.getElementById('btnExportCsv').addEventListener('click', () => {
      const header = 'Date,Pair,Direction,Size,P&L,Strategy,Notes\n';
      const rows = trades.map(t => `${t.date},${t.pair},${t.direction},${t.size ?? 0},${t.pnl ?? 0},${t.strategy ?? ''},${(t.notes ?? '').replace(/\n/g, ' ')}`).join('\n');
      downloadBlob(header + rows, 'trading-journal.csv', 'text/csv');
    });

    

    function downloadBlob(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    loadState();
  </script>
</body>
</html>

